<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Rupee Watch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles (Dark Mode) */
        :root {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --card-bg: #1f2937;
            --border-color: #374151;
            --input-bg: #374151;
            --modal-text: #1f2937;
            --modal-bg: #ffffff;
            --text-color-muted: #9ca3af;
        }

        /* Light Mode styles */
        body.light-mode {
            --bg-color: #f3f4f6;
            --text-color: #111827;
            --card-bg: #ffffff;
            --border-color: #d1d5db;
            --input-bg: #e5e7eb;
            --modal-text: #1f2937;
            --modal-bg: #ffffff;
            --text-color-muted: #4b5563;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
        .video-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: var(--card-bg);
        }
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .locked::after {
            content: 'üîí';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; color: white;
            background-color: rgba(0, 0, 0, 0.6);
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            border-radius: 0.5rem; cursor: pointer;
        }
        .serial-tag {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .serial-tag:hover {
            background-color: var(--input-bg);
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <!-- Top Bar with Login and Theme Toggle -->
        <div class="absolute top-4 right-4 flex items-center space-x-4 z-10">
             <div id="visitor-counter" class="hidden bg-gray-700 text-white text-sm font-bold py-2 px-4 rounded-lg">
                Visitors: <span id="visitor-count-span">0</span>
            </div>
            <button id="theme-toggle" class="bg-gray-700 text-white rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-dark" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
            <button id="admin-login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Admin Login</button>
            <button id="admin-logout-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
        </div>
        
        <header class="text-center mb-10 pt-16">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight">One Rupee Watch</h1>
            <p style="color: var(--text-color-muted);" class="mt-2">Watch all serials for ‚Çπ1</p>
        </header>

        <!-- Serial Search Section -->
        <section class="mb-6 max-w-2xl mx-auto">
            <label for="serial-search-input" class="block text-lg font-medium mb-2 text-center">Search for a Serial</label>
            <div class="flex">
                <input type="text" id="serial-search-input" placeholder="e.g., Big boss 19" class="w-full p-3 rounded-l-md" style="background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color);">
                <button id="serial-search-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-r-md">Search</button>
            </div>
            <div class="mt-4 p-3 rounded-md bg-sky-900 text-sky-100 text-sm text-center border border-sky-700">
                <p>Please write the serial name correctly. Search on Google for the exact name.</p>
                <p class="mt-1">‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Ä‡§∞‡§ø‡§Ø‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡§π‡•Ä ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§ ‡§∏‡§ü‡•Ä‡§ï ‡§®‡§æ‡§Æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡•Ç‡§ó‡§≤ ‡§™‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç‡•§</p>
            </div>
        </section>

        <!-- Or Select From List Section -->
        <section id="serial-list-section" class="text-center mb-10 max-w-3xl mx-auto">
             <p class="text-sm uppercase tracking-wider mb-4" style="color: var(--text-color-muted);">Or Select From Our List</p>
             <div id="serial-tags-container" class="flex flex-wrap justify-center gap-3">
                <!-- Serial tags will be dynamically inserted here from Firebase -->
             </div>
        </section>

        <!-- Contact Me Section -->
        <section class="text-center mb-12 max-w-3xl mx-auto p-6 rounded-lg" style="background-color: var(--card-bg);">
            <h2 class="text-2xl font-bold mb-4">Want to see a specific serial?</h2>
            <p class="mb-6" style="color: var(--text-color-muted);">
                Tell us which serial you want to watch, and we'll upload it for you.
                <br>
                ‡§Ü‡§™‡§ï‡•ã ‡§ï‡•å‡§® ‡§∏‡§æ ‡§∏‡•Ä‡§∞‡§ø‡§Ø‡§≤ ‡§¶‡•á‡§ñ‡§®‡§æ ‡§π‡•à ‡§π‡§Æ‡•á‡§Ç ‡§¨‡§§‡§æ‡§è‡§Ç, ‡§î‡§∞ ‡§π‡§Æ ‡§â‡§∏‡•á ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§¶‡•á‡§Ç‡§ó‡•á‡•§
            </p>
            <a href="mailto:harshzxc5705@gmail.com?subject=Serial Request from One Rupee Watch" 
               class="inline-block bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105">
               Request a Serial
            </a>
        </section>

        <!-- Admin Upload Section (Hidden by default) -->
        <section id="upload-section" style="background-color: var(--card-bg);" class="p-6 rounded-lg shadow-lg mb-12 hidden">
            <h2 class="text-2xl font-semibold mb-4">Add New Episode</h2>
            <div class="mb-4">
                <label for="serial-name" class="block text-sm font-medium mb-2">Serial Name</label>
                <input type="text" id="serial-name" placeholder="Name of the TV Serial" class="w-full p-2 rounded-md" style="background-color: var(--input-bg); border: 1px solid var(--border-color);">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="video-file" class="block text-sm font-medium mb-2">Video File URL</label>
                    <input type="text" id="video-file" placeholder="https://your-host.com/video.mp4" class="w-full p-2 rounded-md" style="background-color: var(--input-bg); border: 1px solid var(--border-color);">
                </div>
                <div>
                    <label for="episode-number" class="block text-sm font-medium mb-2">Episode Number</label>
                    <input type="number" id="episode-number" placeholder="e.g., 101" class="w-full p-2 rounded-md" style="background-color: var(--input-bg); border: 1px solid var(--border-color);">
                </div>
            </div>
            <div class="mt-6 text-right">
                <button id="upload-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Add Episode</button>
            </div>
        </section>

        <!-- Episode Filter Section (Hidden by default) -->
        <section id="episode-filter-section" class="mb-6 max-w-2xl mx-auto hidden">
            <label for="episode-filter-input" class="block text-lg font-medium mb-2 text-center">Filter by Episode Number</label>
            <input type="text" id="episode-filter-input" placeholder="e.g., 101" class="w-full p-3 rounded-md" style="background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color);">
        </section>

        <!-- Video Gallery -->
        <main id="video-gallery-container">
            <!-- Data will be loaded from Firebase -->
        </main>
    </div>

    <!-- MODALS -->

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div style="color: var(--modal-text); background-color: var(--modal-bg);" class="rounded-lg shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold mb-2">Unlock All Episodes!</h3>
            <p class="mb-4">1. Scan the QR code with any UPI app to pay ‚Çπ1.</p>
            <div class="flex justify-center mb-4">
                <img src="https://i.ibb.co/zVctYVCK/Whats-App-Image-2025-09-03-at-11-59-10-AM.jpg" alt="UPI QR Code" class="border rounded-md w-48 h-48">
            </div>
            <p class="text-sm mb-4">Or use UPI ID: <strong class="select-all">harshzxc5701@oksbi</strong></p>
            <p class="mb-4">2. Enter the 12-digit UPI Transaction ID below.</p>
            <div>
                <input type="text" id="upi-id-input" placeholder="Enter UPI Transaction ID" class="w-full p-2 border border-gray-300 rounded-md mb-4 text-gray-800">
                <p id="upi-error-message" class="text-red-500 text-sm mb-4 hidden">Please enter a valid 12-digit Transaction ID.</p>
            </div>
            <div class="flex flex-col space-y-3">
                 <button id="verify-payment-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Verify Payment</button>
                 <button id="cancel-button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Login Modal -->
    <div id="admin-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div style="color: var(--modal-text); background-color: var(--modal-bg);" class="rounded-lg shadow-2xl p-8 max-w-sm w-full">
            <h3 class="text-2xl font-bold mb-4">Admin Login</h3>
            <p class="mb-6">Enter the password to access upload features.</p>
            <input type="password" id="admin-password" class="w-full border border-gray-300 rounded-md p-2 mb-4 text-gray-800" placeholder="Password">
            <p id="error-message" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
            <div class="flex justify-end space-x-3">
                 <button id="login-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                 <button id="login-submit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Login</button>
            </div>
        </div>
    </div>

    <!-- Edit Episode Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div style="color: var(--modal-text); background-color: var(--modal-bg);" class="rounded-lg shadow-2xl p-8 max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-6">Edit Episode</h3>
            <input type="hidden" id="edit-video-id">
            <div class="space-y-4">
                <div>
                    <label for="edit-serial-name" class="block text-sm font-medium mb-1">Serial Name</label>
                    <input type="text" id="edit-serial-name" class="w-full p-2 border border-gray-300 rounded-md text-gray-800">
                </div>
                <div>
                    <label for="edit-video-file" class="block text-sm font-medium mb-1">Video File URL</label>
                    <input type="text" id="edit-video-file" class="w-full p-2 border border-gray-300 rounded-md text-gray-800">
                </div>
                <div>
                    <label for="edit-episode-number" class="block text-sm font-medium mb-1">Episode Number</label>
                    <input type="number" id="edit-episode-number" class="w-full p-2 border border-gray-300 rounded-md text-gray-800">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-8">
                 <button id="edit-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                 <button id="edit-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
     <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div style="color: var(--modal-text); background-color: var(--modal-bg);" class="rounded-lg shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold mb-4">Are you sure?</h3>
            <p class="mb-6">This episode will be permanently deleted. This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                 <button id="delete-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg">Cancel</button>
                 <button id="delete-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="success-toast" class="hidden fixed bottom-5 right-5 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg transition-transform transform translate-y-20">
        Action successful!
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, runTransaction, increment, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC6X2J9n4QLCpBMTOkibbf2jnuZINfa0lM",
          authDomain: "ruppewatch.firebaseapp.com",
          projectId: "ruppewatch",
          storageBucket: "ruppewatch.firebasestorage.app",
          messagingSenderId: "55956180070",
          appId: "1:55956180070:web:15211af23a2c774095b1a7",
          measurementId: "G-BD82W97QMW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL DATA ---
        let videoData = [];

        // --- DOM ELEMENTS ---
        const galleryContainer = document.getElementById('video-gallery-container');
        const paymentModal = document.getElementById('payment-modal');
        const verifyPaymentBtn = document.getElementById('verify-payment-btn');
        const cancelButton = document.getElementById('cancel-button');
        const upiIdInput = document.getElementById('upi-id-input');
        const upiErrorMessage = document.getElementById('upi-error-message');
        const serialSearchInput = document.getElementById('serial-search-input');
        const serialSearchBtn = document.getElementById('serial-search-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const serialTagsContainer = document.getElementById('serial-tags-container');
        const episodeFilterSection = document.getElementById('episode-filter-section');
        const episodeFilterInput = document.getElementById('episode-filter-input');
        const visitorCounter = document.getElementById('visitor-counter');
        const visitorCountSpan = document.getElementById('visitor-count-span');
        const successToast = document.getElementById('success-toast');

        // Admin elements
        const uploadSection = document.getElementById('upload-section');
        const uploadBtn = document.getElementById('upload-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminModal = document.getElementById('admin-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const loginCancelBtn = document.getElementById('login-cancel-btn');
        const errorMessage = document.getElementById('error-message');

        // Edit Modal elements
        const editModal = document.getElementById('edit-modal');
        const editVideoId = document.getElementById('edit-video-id');
        const editSerialName = document.getElementById('edit-serial-name');
        const editVideoFile = document.getElementById('edit-video-file');
        const editEpisodeNumber = document.getElementById('edit-episode-number');
        const editSaveBtn = document.getElementById('edit-save-btn');
        const editCancelBtn = document.getElementById('edit-cancel-btn');

        // Delete Modal elements
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');

        // --- STATE MANAGEMENT ---
        let unlockedSerials = new Set();
        const ADMIN_PASSWORD = 'Vn8s$Kz@P5qR';
        let currentSerial = '';
        let currentSerialVideos = [];
        let isAdminLoggedIn = false;
        let videoIdToDelete = null;

        // --- FUNCTIONS ---
        
        function handlePaymentVerification() {
            const upiId = upiIdInput.value.trim();
            if (upiId.length === 12 && /^\d+$/.test(upiId)) {
                if (currentSerial) {
                    unlockedSerials.add(currentSerial.toLowerCase());
                    paymentModal.classList.add('hidden');
                    upiIdInput.value = '';
                    upiErrorMessage.classList.add('hidden');
                    renderGallery(currentSerial); // Re-render to show unlocked videos
                }
            } else {
                upiErrorMessage.classList.remove('hidden');
            }
        }

        function populateSerialTags() {
            const uniqueSerialNames = [...new Set(videoData.map(v => v.serialName))];
            serialTagsContainer.innerHTML = uniqueSerialNames.map(name => 
                `<button class="serial-tag text-sm font-semibold px-4 py-2 rounded-lg">${name}</button>`
            ).join('');

            document.querySelectorAll('.serial-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    serialSearchInput.value = tag.textContent;
                    serialSearchBtn.click();
                });
            });
        }
        
        function displayVideos(videoList) {
            galleryContainer.innerHTML = ''; 

            if (videoList.length === 0) {
                galleryContainer.innerHTML = `<p class="text-center text-lg" style="color: var(--text-color-muted);">No matching episodes found.</p>`;
                return;
            }
            
            // Sort videos by episode number numerically
            const sortedVideos = videoList.sort((a, b) => Number(a.episode) - Number(b.episode));

            galleryContainer.innerHTML = `
                <section class="mb-10">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        ${sortedVideos.map(video => createVideoCard(video)).join('')}
                    </div>
                </section>
            `;
            
            addCardEventListeners();
        }

        function renderGallery(serialName) {
            currentSerial = serialName;
            const lowerCaseSerial = serialName.toLowerCase().trim();
            currentSerialVideos = videoData.filter(
                video => video.serialName.toLowerCase().trim() === lowerCaseSerial
            );
            if (currentSerialVideos.length === 0) {
                 galleryContainer.innerHTML = `<p class="text-center text-lg" style="color: var(--text-color-muted);">No videos found for "${serialName}". Please check the spelling.</p>`;
                episodeFilterSection.classList.add('hidden');
            } else {
                episodeFilterSection.classList.remove('hidden');
                episodeFilterInput.value = '';
                displayVideos(currentSerialVideos);
            }
        }

        function createVideoCard(video) {
            const isUnlocked = unlockedSerials.has(video.serialName.toLowerCase());
            const lockClass = (isUnlocked || isAdminLoggedIn) ? '' : 'locked';
            
            const adminButtons = isAdminLoggedIn ? `
                <div class="absolute top-2 right-2 flex space-x-2">
                    <button class="edit-btn p-1.5 bg-blue-600 rounded-full hover:bg-blue-700" data-id="${video.id}">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                    <button class="delete-btn p-1.5 bg-red-600 rounded-full hover:bg-red-700" data-id="${video.id}">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            ` : '';

            return `
                <div class="video-card rounded-lg overflow-hidden shadow-lg relative" data-url="${video.videoUrl}" data-id="${video.id}">
                    <div class="relative ${lockClass}">
                        <img src="${video.thumbnail}" alt="Episode ${video.episode}" class="w-full h-48 object-cover cursor-pointer">
                        ${adminButtons}
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg">Episode ${video.episode}</h3>
                        ${isUnlocked ? `
                            <button class="download-btn mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Download</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function addCardEventListeners() {
             document.querySelectorAll('.video-card img').forEach(cardImage => {
                cardImage.addEventListener('click', () => {
                    const card = cardImage.closest('.video-card');
                    const isUnlocked = unlockedSerials.has(currentSerial.toLowerCase());
                    
                    if (isUnlocked || isAdminLoggedIn) {
                        window.open(card.dataset.url, '_blank');
                    } else {
                        paymentModal.classList.remove('hidden');
                    }
                });
            });
            document.querySelectorAll('.download-btn').forEach(btn => {
                 btn.addEventListener('click', () => window.open(btn.closest('.video-card').dataset.url, '_blank'));
            });

            if (isAdminLoggedIn) {
                document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(btn.dataset.id);
                }));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDeleteConfirm(btn.dataset.id);
                }));
            }
        }
        
        function applyTheme(theme) {
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            } else {
                document.body.classList.remove('light-mode');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        function handleAdminLogin() {
             if (adminPasswordInput.value === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                adminModal.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                adminLoginBtn.classList.add('hidden');
                adminLogoutBtn.classList.remove('hidden');
                visitorCounter.classList.remove('hidden');
                adminPasswordInput.value = '';
                errorMessage.classList.add('hidden');
                if(currentSerial) renderGallery(currentSerial);
            } else {
                errorMessage.classList.remove('hidden');
            }
        }
        function handleAdminLogout() {
             isAdminLoggedIn = false;
             uploadSection.classList.add('hidden');
             adminLoginBtn.classList.remove('hidden');
             adminLogoutBtn.classList.add('hidden');
             visitorCounter.classList.add('hidden');
             if(currentSerial) renderGallery(currentSerial);
        }

        function showSuccessToast(message = "Action successful!") {
            successToast.textContent = message;
            successToast.classList.remove('hidden', 'translate-y-20');
            setTimeout(() => {
                successToast.classList.add('translate-y-20');
                setTimeout(() => successToast.classList.add('hidden'), 300);
            }, 3000);
        }

        async function handleUpload() {
            const serialName = document.getElementById('serial-name').value.trim();
            const videoUrl = document.getElementById('video-file').value.trim();
            const episodeNumber = document.getElementById('episode-number').value.trim();
            
            if (!serialName || !videoUrl || !episodeNumber) {
                alert('Please fill out all fields in the admin form.');
                return;
            }

            const newVideo = {
                serialName: serialName,
                episode: episodeNumber,
                thumbnail: `https://placehold.co/600x400/1e293b/ffffff?text=Episode+${episodeNumber}`,
                videoUrl: videoUrl
            };
            
            try {
                await addDoc(collection(db, "videos"), newVideo);
                showSuccessToast("Episode added successfully!");
                document.getElementById('serial-name').value = '';
                document.getElementById('video-file').value = '';
                document.getElementById('episode-number').value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Error saving episode. Check console for details.");
            }
        }

        function openEditModal(videoId) {
            const video = videoData.find(v => v.id === videoId);
            if(video) {
                editVideoId.value = video.id;
                editSerialName.value = video.serialName;
                editVideoFile.value = video.videoUrl;
                editEpisodeNumber.value = video.episode;
                editModal.classList.remove('hidden');
            }
        }

        async function handleUpdateEpisode() {
            const videoId = editVideoId.value;
            const updatedData = {
                serialName: editSerialName.value,
                videoUrl: editVideoFile.value,
                episode: editEpisodeNumber.value,
                thumbnail: `https://placehold.co/600x400/1e293b/ffffff?text=Episode+${editEpisodeNumber.value}`
            };

            const videoRef = doc(db, "videos", videoId);
            try {
                await updateDoc(videoRef, updatedData);
                editModal.classList.add('hidden');
                showSuccessToast("Episode updated successfully!");
            } catch (e) {
                console.error("Error updating document: ", e);
                alert("Error updating episode. Check console.");
            }
        }

        function openDeleteConfirm(videoId) {
            videoIdToDelete = videoId;
            deleteConfirmModal.classList.remove('hidden');
        }

        async function handleDeleteEpisode() {
            if (!videoIdToDelete) return;
            try {
                await deleteDoc(doc(db, "videos", videoIdToDelete));
                deleteConfirmModal.classList.add('hidden');
                showSuccessToast("Episode deleted successfully!");
                videoIdToDelete = null;
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("Error deleting episode. Check console.");
            }
        }

        function fetchVideos() {
            const q = query(collection(db, "videos"));
            onSnapshot(q, (querySnapshot) => {
                videoData = [];
                querySnapshot.forEach((doc) => {
                    videoData.push({ id: doc.id, ...doc.data() });
                });
                console.log("Data refreshed from Firebase. Total items: ", videoData.length);
                
                populateSerialTags();

                if (currentSerial) {
                    renderGallery(currentSerial);
                } else {
                    galleryContainer.innerHTML = `<p class="text-center text-lg" style="color: var(--text-color-muted);">Please search for a serial or select one from the list above.</p>`;
                }
            });
        }
        async function updateVisitorCount() {
            const counterRef = doc(db, "analytics", "visitorCounter");
            try {
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    if (!counterDoc.exists()) {
                        transaction.set(counterRef, { count: 1 });
                    } else {
                        transaction.update(counterRef, { count: increment(1) });
                    }
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
            }
        }

        function listenForVisitorCount() {
            const counterRef = doc(db, "analytics", "visitorCounter");
            onSnapshot(counterRef, (doc) => {
                if (doc.exists()) {
                    visitorCountSpan.textContent = doc.data().count;
                } else {
                    visitorCountSpan.textContent = "0";
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            themeToggle.addEventListener('click', () => {
                const newTheme = document.body.classList.contains('light-mode') ? 'dark' : 'light';
                applyTheme(newTheme);
            });
            
            fetchVideos();
            updateVisitorCount();
            listenForVisitorCount();

            cancelButton.addEventListener('click', () => paymentModal.classList.add('hidden'));
            verifyPaymentBtn.addEventListener('click', handlePaymentVerification);
            
            serialSearchBtn.addEventListener('click', () => {
                const searchTerm = serialSearchInput.value;
                if (searchTerm.trim() !== '') {
                    renderGallery(searchTerm);
                    setTimeout(() => {
                        episodeFilterSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            });
            serialSearchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    serialSearchBtn.click();
                }
            });

            episodeFilterInput.addEventListener('input', () => {
                const filterTerm = episodeFilterInput.value.toLowerCase().trim();
                const filteredVideos = currentSerialVideos.filter(video => 
                    video.episode.toString().includes(filterTerm)
                );
                displayVideos(filteredVideos);
            });

            adminLoginBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
            loginCancelBtn.addEventListener('click', () => adminModal.classList.add('hidden'));
            loginSubmitBtn.addEventListener('click', handleAdminLogin);
            adminLogoutBtn.addEventListener('click', handleAdminLogout);
            uploadBtn.addEventListener('click', handleUpload);
            
            editSaveBtn.addEventListener('click', handleUpdateEpisode);
            editCancelBtn.addEventListener('click', () => editModal.classList.add('hidden'));
            deleteConfirmBtn.addEventListener('click', handleDeleteEpisode);
            deleteCancelBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        });
    </script>
</body>
</html>


